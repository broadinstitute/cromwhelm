{{- if .Values.cbas.enabled }}
{{ include "terra-batch-libchart.cbas-api-deploy" (list . "coa-helm.cbas-api-deploy") }}
{{ end }}
{{ define "coa-helm.cbas-api-deploy" }}
# Overrides go here
spec:
  template:
    metadata:
      labels:
  {{ include "coa-helm.labels" $ | nindent 8 }}
{{ end }}

---
{{- if .Values.cbas.enabled }}
{{ include "terra-batch-libchart.cbas-api-service" (list . "coa-helm.cbas-api-service") }}
{{ end }}
{{ define "coa-helm.cbas-api-service" }}
# Overrides go here
{{ end }}

---
{{- if .Values.cbas.enabled }}
{{ include "terra-batch-libchart.cbas-api-config" (list . "coa-helm.cbas-api-config") }}
{{ end }}
{{ define "coa-helm.cbas-api-config" }}
# Overrides go here
data:
  {{ .Values.cbas.conf_file }}: |-
    spring:
      datasource:
        jdbc-url: jdbc:postgresql://{{ include "app.fullname" . }}-postgres:{{ .Values.postgres.port }}/{{ .Values.postgres.cbas.dbname }}
        username: {{ .Values.postgres.user }}
        password: {{ include "dbPassword" . | b64enc | quote }}
      sql:
        init:
          mode: always
      liquibase:
        url: jdbc:postgresql://{{ include "app.fullname" . }}-postgres:{{ .Values.postgres.port }}/{{ .Values.postgres.cbas.dbname }}
        user: {{ .Values.postgres.user }}
        password: {{ include "dbPassword" . | b64enc | quote }}
        change-log: changelog/changelog.yaml
    cbas:
      cbas-database:
        uri: jdbc:postgresql://{{ include "app.fullname" . }}-postgres:{{ .Values.postgres.port }}/{{ .Values.postgres.cbas.dbname }}
        username: {{ .Values.postgres.user }}
        password: {{ include "dbPassword" . | b64enc | quote }}
    workflow-engines:
      cromwell:
        baseUri: 'http://{{ include "app.fullname" . }}-cromwell-svc:8000'
        finalWorkflowLogDir: "https://{{ .Values.persistence.storageAccount }}.blob.core.windows.net/{{ .Values.persistence.blobContainer }}/workspace-services/cbas/{{ .Values.persistence.leoAppInstanceName }}/cromwell-workflow-logs"
    wds:
      instanceId: "{{ .Values.persistence.workspaceManager.workspaceId }}"
      apiV: "v0.2"
    leonardo:
      baseUri: "{{ .Values.leonardo.url }}"
      wdsAppTypeNames: ['WDS', 'CROMWELL']
      dependencyUrlCacheTtlSeconds: 300
    credentials:
      azure:
        tokenAcquisitionTimeoutSeconds: 5
        tokenCacheTtlSeconds: 300
    terra.common:
      tracing:
        stackdriverExportEnabled: false
    dockstore:
      baseUrl: "{{ .Values.dockstore.baseUrl}}"
{{ end }}
